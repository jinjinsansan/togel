"# TapeAI 開発詳細計画書\n\n## 1. 目的・KPI\n- **プロダクトゴール**: “恋愛相談AI”入口から本格心理カウンセリングへ接続し、「今日生きててよかった」を継続的に提供。\n- **Phase別主要KPI**\n  - Phase0: `next dev`起動、Supabase接続、RAG登録スクリプト完走。\n  - Phase1: ユーザー登録→カテゴリ選択→AIチャット→課金誘導までE2E成功率90%以上。\n  - Phase2: 診断完了率70%、履歴再開成功率95%、ポイント課金決済成功率99%。\n  - Phase3: Web Vitals LCP < 2.5s、Sentry致命的エラー0件/週、稼働率99.5%。\n\n## 2. 体制・役割\n| ロール | ミッション | 主要アウトプット |\n| --- | --- | --- |\n| Tech Lead | 設計判断・品質ゲート | アーキレビュー、リリース承認 |\n| Frontend | Next.js UI/UX | App Router実装、shadcn/ui拡張 |\n| Backend | API/RAG/課金 | Supabase運用、Claude/Stripe連携 |\n| MLOps | ナレッジ整備・RAG品質 | Embedding、メタデータ管理 |\n| QA | シナリオテスト・負荷試験 | テスト仕様、回帰結果 |\n| PM | スプリント進行・リスク管理 | バーンダウン、ふりかえり |\n\n## 3. 共通準備 (Week0)\n1. **リポジトリ初期化**: `pnpm create next-app --ts`、ESLint/Prettier設定、CIテンプレ作成。\n2. **Secrets管理**: 1Password/VaultでSupabase・Stripe・Anthropicキー共有。\n3. **開発環境**: Volta/asdfでNode v20固定、pnpm導入、`husky + lint-staged`。\n4. **自動テスト基盤**: Vitest + Playwright雛形、GitHub Actions(install→lint→test→build)。\n5. **ドキュメント運用**: Notion/Linearでバックログ、決定事項は必要に応じ docs/decisions/ADR-XXXX.md。\n\n## 4. フェーズ別計画\n### Phase 0: 環境構築 (Week0, 1w)\n| タスク | 詳細 | 完了条件 |\n| --- | --- | --- |\n| P0-1 プロジェクト初期化 | Next.js14, Tailwind, shadcn/ui導入、`src`構成雛形 | `pnpm dev`でLP表示 |\n| P0-2 Supabase整備 | プロジェクト作成、スキーマ適用、RLSテンプレ | `supabase db reset`成功 |\n| P0-3 RAG基盤 | `scripts/chunk-knowledge.ts`, `insert_embeddings.ts` | `knowledge`テーブルTop5検索可 |\n| P0-4 外部連携Stub | Stripe test keys, Anthropic mock, Resend sandbox | `.env.example`更新・接続確認 |\n| P0-5 Vercel/Cloudflare | Preview環境・独自ドメイン設定 | `main` pushでデプロイ成功 |\n\n### Phase 1: MVP (Week1-3)\n**Week1 – 認証+UI**\n- Supabase Auth (Email/Password + Google) とmiddleware保護。\n- (auth)レイアウト、`/login`,`/register`、LP/料金表示。\n- shadcn/uiカタログ or Storybook。\n\n**Week2 – AIチャット**\n- `/chat/[category]` UI（MessageList/Stream/AutosizeInput）。\n- `/api/chat`: JWT検証→RAG→Claude streaming→Supabase保存。\n- セッション一覧/詳細API、カテゴリ別システムプロンプト。\n- トークン/ポイント概算util。\n\n**Week3 – 課金**\n- Stripe price・Checkout Session API・Webhook同期。\n- サブスクDBと無料枠ミドルウェア、ガードUI。\n- ダッシュボードにプランカード/残り回数表示。\n- PlaywrightでAuth→Chat→Billing E2E。\n\n### Phase 2: 拡張 (Week4-5)\n**Week4 – 診断 & 履歴**\n- `constants/diagnosis.ts`質問定義、`/diagnosis/[type]`フロー。\n- スコアリング/結果保存API、相談誘導。\n- `/chat/history`検索・再開・削除、CSVエクスポート。\n\n**Week5 – ポイント課金 & UX**\n- `user_points`実装、Stripe単発決済→ポイント反映。\n- 残高表示、残少通知。\n- Onboarding/ツールチップ/toast/ダークモード。\n- LINE/Appleログイン、PWリセット。\n\n### Phase 3: 本番運用 (Week6)\n- Cloudflare Images/Next Image最適化、bundle analyze。\n- Edge Middlewareでレート制限、Security Headers。\n- Sentry + Vercel Analytics + Health check。\n- 利用規約/プライバシー/特商法ページ生成。\n- 本番リリース/ロールバック手順整備。\n\n## 5. テスト戦略\n| レイヤー | ツール | タイミング |\n| --- | --- | --- |\n| Unit | Vitest + Testing Library | 各PR |\n| Integration | Supabase Test DB + Vitest | API/Store改修時 |\n| E2E | Playwright (auth/chat/billing/diagnosis) | スプリント末 & リリース前 |\n| Perf | Lighthouse CI + k6チャット負荷 | Phase1完了、Phase3 |\n| Security | OWASP Zap baseline, Stripe署名確認 | Phase3 |\n\n## 6. リスク & 対策\n| リスク | 影響 | 対策 |\n| --- | --- | --- |\n| RAG精度不足 | カウンセリング品質低下 | チャンク/メタ調整、週次レビュー |\n| 課金不具合 | 収益損失 | Webhook再試行 + 手動調整ツール |\n| Claude遅延 | UX劣化 | Timeoutハンドラ/フォールバック |\n| セキュリティ事故 | 個人情報漏洩 | RLS/JWT/Rate limit/定期PenTest |\n| リリース遅延 | 公開遅延 | 2週スプリント+Scope Control |\n\n## 7. マイルストーン\n- **M0 (W0末)**: 開発環境/CI/DB準備完了。\n- **M1 (W2末)**: 認証+チャット動線デモ。\n- **M2 (W3末)**: MVPリリース判定。\n- **M3 (W5末)**: 拡張機能QA、β開始。\n- **M4 (W6末)**: 本番デプロイ。\n\n## 8. リリース手順 (Phase3)\n1. `main` freeze → Release branch。\n2. 自動テスト + 負荷/セキュリティ追加チェック。\n3. Stripe/Supabase/Vercel環境確認、Webhook redeploy。\n4. Cloudflare DNS切替、監視アラート有効化。\n5. Go/No-Goミーティング → 本番デプロイ。\n6. 24hモニタリング、事後レポート & レトロ。\n""
