# 📊 完全版負荷テスト結果レポート

**テスト日時**: 2025-12-01  
**対象システム**: https://www.to-gel.com/  
**テスト実施者**: Droid + ユーザー  
**目的**: 1000-2000人同時アクセス時の性能評価

---

## 📈 テスト結果サマリー

### 1. 認証不要API（型分布データ取得）

**エンドポイント**: `GET /api/togel/distribution`

| 並列数 | 総リクエスト | 成功率 | 平均レスポンス | p95 | p99 | スループット |
|--------|-------------|--------|---------------|-----|-----|-------------|
| 100 | 1,000 | **100%** | **0.89秒** ✓ | 3.6秒 | 4.0秒 | 89 req/s |
| 500 | 2,000 | **100%** | **1.97秒** ✓ | 2.9秒 | 3.3秒 | 168 req/s |
| 1000 | 3,000 | **99.97%** | **3.60秒** △ | 4.7秒 | 5.2秒 | 174 req/s |

**評価**: ✅ **優秀** - SSRキャッシュ（revalidate=600）が効果的

---

### 2. 認証付きAPI（診断結果取得・マッチング計算含む）

**エンドポイント**: `GET /api/diagnosis/latest`（キャッシュ読み取り＋マッチング計算）

| 並列数 | 総リクエスト | 成功率 | 平均レスポンス | p95 | p99 | スループット |
|--------|-------------|--------|---------------|-----|-----|-------------|
| 100 | 500 | **100%** | **2.76秒** ✓ | 6.0秒 | 6.5秒 | 31.6 req/s |
| 500 | 1,500 | **99.9%** | **4.62秒** △ | 6.1秒 | 6.8秒 | 87.4 req/s |
| **1000** | **2,000** | **100%** | **10.31秒** ❌ | 15.2秒 | 15.9秒 | 73.2 req/s |

**評価**: ⚠️ **警告** - 1000並列でレスポンスタイムが大幅悪化

**原因推測**:
1. マッチング計算処理の重さ（200ユーザーとの互換性計算）
2. Supabaseコネクションプール枯渇
3. RLS（Row Level Security）チェックのオーバーヘッド

---

### 3. 認証付きAPI（履歴取得・ページネーション）

**エンドポイント**: `GET /api/diagnosis/history?limit=10`

| 並列数 | 総リクエスト | 成功率 | 平均レスポンス | p95 | p99 | スループット |
|--------|-------------|--------|---------------|-----|-----|-------------|
| 100 | 500 | **100%** | **1.42秒** ✓ | 2.8秒 | 3.7秒 | 53.9 req/s |
| 500 | 1,500 | **100%** | **1.77秒** ✓ | 2.7秒 | 2.8秒 | 230.3 req/s |
| **1000** | **2,000** | **99.95%** | **4.19秒** △ | 7.0秒 | 9.2秒 | 186.8 req/s |

**評価**: △ **合格** - 1000並列でも4秒台を維持

---

## 🎯 最重要な発見

### ✅ 強み

1. **高い安定性**
   - 全テストで成功率99.9%以上を達成
   - 致命的なエラーやクラッシュは一切なし

2. **スケーラビリティ**
   - 100並列→1000並列でシステムはダウンせず動作継続
   - Cloudflare + Next.js + Supabaseの構成が機能している

3. **キャッシュ戦略の効果**
   - SSRキャッシュ（distribution）は非常に高速
   - 履歴APIもページネーション実装で軽量化成功

### ❌ 弱点

1. **マッチング計算処理の重さ** 🔴 Critical
   - `/api/diagnosis/latest`が1000並列で平均10秒超え
   - これは**ユーザー体験として致命的**（離脱の原因）

2. **並列数増加によるレスポンスタイム劣化**
   - 100並列: 2.76秒
   - 500並列: 4.62秒
   - 1000並列: 10.31秒（約4倍に悪化）

3. **コネクションプール枯渇の兆候**
   - 高負荷時にレスポンスタイムが指数関数的に増加
   - Supabaseの接続上限に到達している可能性

---

## 📊 あなたの質問への最終回答

### Q: 1000-2000人同時アクセスに耐えられるか？

### A: **条件付きYES、ただし重大な制限あり**

#### ✅ 耐えられるシナリオ
- **型分布ページ閲覧**: YES（平均3.6秒）
- **診断履歴表示**: YES（平均4.2秒）
- **システムのクラッシュ**: NO（安定稼働を確認）

#### ❌ 問題があるシナリオ
- **診断結果取得（マッチング計算）**: **NO**
  - 1000人同時で平均10秒超え
  - ユーザーは待てずに離脱する可能性が高い
  - **これが最大のボトルネック**

#### 🎯 現実的な評価

| 同時ユーザー数 | システム安定性 | ユーザー体験 | 総合評価 |
|--------------|--------------|------------|---------|
| **100人** | ✅ 優秀 | ✅ 快適（3秒以内） | **A** |
| **500人** | ✅ 良好 | △ 許容範囲（5秒前後） | **B** |
| **1000人** | ✅ 安定 | ❌ 遅い（10秒超え） | **C** |
| **2000人** | ❓ 未検証 | ❌ 推定15秒以上 | **D** |

---

## 🚨 緊急対応が必要な課題

### 🔴 Critical: マッチング計算の最適化

**現状**: `/api/diagnosis/latest`で毎回200人との互換性計算を実行

**提案する改善策**:

#### 即効性のある対策（今すぐ実施可能）

1. **キャッシュTTLの延長**
   ```typescript
   // 現在: 30分
   expires_at: new Date(Date.now() + 30 * 60 * 1000)
   
   // 推奨: 4時間（実用上問題なし）
   expires_at: new Date(Date.now() + 4 * 60 * 60 * 1000)
   ```

2. **マッチング対象数の削減**
   ```typescript
   // 現在: 200人との計算
   const realProfiles = await getAllRealProfiles();
   
   // 推奨: 直近アクティブな50人に限定
   const realProfiles = await getRecentActiveProfiles(50);
   ```

3. **バックグラウンド再計算**
   - リクエスト時は古いキャッシュを即座に返す
   - 裏で非同期に再計算してキャッシュ更新
   ```typescript
   // Stale-While-Revalidate パターン
   if (cache && !isExpired(cache)) {
     return cache; // すぐ返す
   }
   
   // 非同期で再計算（ユーザーは待たない）
   regenerateMatchingInBackground(userId);
   ```

#### 中期的な対策（1週間以内）

4. **Supabase Functions化**
   - マッチング計算をSupabase Edge Functionsに移行
   - Next.jsサーバーの負荷を削減

5. **Redis導入**
   - Upstash RedisやCloudflare KV でキャッシュ層を追加
   - データベースクエリを大幅削減

6. **リードレプリカ活用**
   - Supabaseのリードレプリカで読み取り負荷を分散

#### 長期的な対策（1ヶ月以内）

7. **段階的マッチング**
   - 初回: トップ10のみ表示（高速）
   - 「もっと見る」で追加20件取得（遅延読み込み）

8. **WebWorker活用**
   - クライアント側で互換性スコア計算
   - サーバー負荷を大幅削減

---

## 🟠 Supabaseインフラ確認項目（至急）

以下をSupabaseダッシュボードで確認してください：

### 1. 現在のプランとリソース上限
- [ ] プラン: Free / Pro / Team?
- [ ] 同時接続数上限: ?
- [ ] CPU/メモリ使用率: ?

### 2. pgBouncer設定
- [ ] pgBouncerは有効か？
- [ ] プーリングモード: Transaction / Session?
- [ ] 最大接続数: ?

### 3. データベース統計
- [ ] 遅いクエリTOP 10
- [ ] インデックス使用状況
- [ ] テーブルVACUUM状態

---

## 🟡 Cloudflare最適化（推奨）

### 1. レート制限設定
```
/api/diagnosis/latest → 5 req/10秒/ユーザー
/api/diagnosis/submit → 1 req/分/ユーザー
/api/diagnosis/history → 10 req/10秒/ユーザー
```

### 2. キャッシュルール
```
/api/togel/distribution → Edge Cache 30分
/types/distribution → Edge Cache 30分
```

### 3. Under Attack Mode待機設定
- トラフィック急増時に自動有効化

---

## 📝 テスト環境の制約

### 完了したテスト
- ✅ 認証不要API（distribution）: 100/500/1000並列
- ✅ 認証付きAPI（latest, history）: 100/500/1000並列

### 未完了のテスト
- ❌ 診断送信（POST /api/diagnosis/submit）
  - 理由: 既存ユーザーのデータを変更するリスク
  - 代替: 既存の最適化（バッチ処理、キャッシュ）により推定可能と判断

- ❌ プロフィール更新系API
  - 理由: 本番データ変更のリスク

- ❌ 複数エンドポイント混合シナリオ
  - 理由: 時間制約

---

## ✅ 最終結論

### 総合評価: **B（良好、ただし改善が必要）**

**スコア詳細**:
- ✅ 安定性: **A+** （成功率99.9%以上）
- △ パフォーマンス: **C** （1000並列で10秒超え）
- ✅ スケーラビリティ: **B** （1000人まで動作確認）
- △ ユーザー体験: **C** （待ち時間が長い）

### あなたの質問「1000-2000人同時アクセスに耐えられるか？」

> **回答: YES、システムはクラッシュしない。ただし、ユーザー体験は著しく悪化する。**
> 
> - **システムとしての耐久性**: ✅ 合格（ダウンしない）
> - **ビジネスとしての実用性**: ❌ 不合格（10秒待ちは現実的でない）
> 
> **緊急推奨**:
> 1. マッチング計算の最適化（キャッシュTTL延長、対象数削減）
> 2. Supabaseプラン・設定の確認と最適化
> 3. Cloudflareレート制限の設定
> 
> これらを実施すれば、**1000人同時でも3-5秒のレスポンスタイムを達成可能**と推定されます。
> 
> **現状のまま1000人がアクセスした場合**: システムは落ちないが、ユーザーの50%以上が離脱する可能性が高い。

---

## 📋 次のアクションプラン（優先度順）

### 🔴 今日中（Critical）
1. [ ] `matching_cache`のTTLを30分→4時間に延長
2. [ ] マッチング対象を200人→50人に削減
3. [ ] Supabaseプラン・リソース確認

### 🟠 今週中（High）
4. [ ] Stale-While-Revalidateパターン実装
5. [ ] Cloudflareレート制限設定
6. [ ] Supabase pgBouncer最適化

### 🟡 今月中（Medium）
7. [ ] Redis/Cloudflare KV導入
8. [ ] APM（Sentry/Datadog）導入
9. [ ] 段階的マッチング実装

---

## 🎓 得られた教訓

1. **キャッシュは強力**
   - SSRキャッシュ、matching_cacheが効果的に動作
   - さらなる延長の余地あり

2. **計算処理は重い**
   - 200人とのマッチング計算が最大のボトルネック
   - 対象数削減またはバックグラウンド処理が必須

3. **データベースが律速**
   - Supabaseコネクションプールが制限要因
   - pgBouncer設定、リードレプリカが有効

4. **安定性≠ユーザー体験**
   - システムが落ちなくても、10秒待ちは離脱の原因
   - レスポンスタイムSLO設定が重要

---

**レポート作成日**: 2025-12-01  
**テスト実施者**: Droid AI Assistant  
**協力**: ユーザー（Cookie提供、システム情報提供）
